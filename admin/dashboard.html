<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ManiMagic - Admin Dashboard</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Playfair+Display:wght@600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/calendar.css">
    <style>
        /* Admin Specific Overrides */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 250px 1fr;
            height: 100vh;
            overflow: hidden;
            /* Prevent body scroll */
        }

        .sidebar {
            background: var(--glass-bg);
            border-right: var(--glass-border);
            padding: 2rem;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .content {
            padding: 1.5rem;
            /* Reduced padding */
            height: 100%;
            overflow-y: auto;
            /* Scroll only if necessary inside content */
            display: flex;
            flex-direction: column;
        }

        /* Inner Dashboard Grid */
        .dashboard-content-grid {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            /* 2 Columns */
            grid-template-rows: auto 1fr;
            gap: 1.5rem;
            flex: 1;
            min-height: 0;
            /* Important for scroll */
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .dashboard-content-grid {
                grid-template-columns: 1fr;
                /* Stack on smaller screens */
                grid-template-rows: auto;
            }
        }

        .left-column {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow-y: auto;
            /* Allow left column to scroll if needed */
            padding-right: 0.5rem;
        }

        .right-column {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Adjust Cards for Grid */
        .auth-card {
            width: 100% !important;
            max-width: none !important;
            margin-bottom: 0 !important;
            padding: 1.5rem !important;
            /* Compact padding */
        }

        .calendar-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .calendar-grid {
            flex: 1;
            /* Adjust grid rows to fit better */
            grid-template-rows: repeat(auto-fill, minmax(40px, 1fr));
        }

        h2.card-title {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            font-family: var(--font-heading);
        }

        .nav-item {
            display: block;
            padding: 1rem;
            margin-bottom: 0.5rem;
            color: var(--text-main);
            text-decoration: none;
            border-radius: 8px;
            transition: background 0.3s;
        }

        .nav-item:hover,
        .nav-item.active {
            background-color: var(--secondary-color);
            color: var(--dark-bg);
            font-weight: 600;
        }
    </style>
</head>

<body>
    <div class="dashboard-grid">
        <!-- Sidebar -->
        <aside class="sidebar">
            <h2 class="brand-title" style="font-size: 1.5rem; text-align: left; margin-bottom: 2rem;">ManiMagic Admin
            </h2>
            <nav style="flex: 1;">
                <a href="dashboard.html" class="nav-item active"><span> Calendario</span></a>
                <a href="inventory.html" class="nav-item"><span> Inventario</span></a>
                <a href="clients.html" class="nav-item">
                    <span> Clientes</span>
                    <span id="client-count-badge" class="nav-badge" style="display: none;">0</span>
                </a>
            </nav>
            <a href="../index.html" class="nav-item" style="margin-top: auto; color: var(--accent-color);"><span>Cerrar
                    Sesi贸n</span></a>
        </aside>

        <!-- Main Content -->
        <main class="content">
            <div id="stock-alert-float" style="position: fixed; top: 2rem; right: 2rem; z-index: 1001;"></div>
            <h1 style="font-family: var(--font-heading); margin-bottom: 1rem; font-size: 1.5rem;">Panel de Control</h1>

            <div class="dashboard-content-grid">
                <!-- Left Column: Availability & Appointments -->
                <div class="left-column">
                    <!-- Availability -->
                    <div class="auth-card">
                        <h2 class="card-title">锔 Disponibilidad</h2>
                        <form id="availabilityForm">
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <!-- Days -->
                                <div style="flex: 1; min-width: 120px;">
                                    <p class="form-label">D铆as:</p>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; font-size: 0.9rem;">
                                        <label><input type="checkbox" name="days" value="1" checked> Lun</label>
                                        <label><input type="checkbox" name="days" value="2" checked> Mar</label>
                                        <label><input type="checkbox" name="days" value="3" checked> Mi茅</label>
                                        <label><input type="checkbox" name="days" value="4" checked> Jue</label>
                                        <label><input type="checkbox" name="days" value="5" checked> Vie</label>
                                        <label><input type="checkbox" name="days" value="6" checked> S谩b</label>
                                        <label><input type="checkbox" name="days" value="0"> Dom</label>
                                    </div>
                                </div>
                                <!-- Hours -->
                                <div style="flex: 1; min-width: 120px;">
                                    <div class="form-group" style="margin-bottom: 0.5rem;">
                                        <label class="form-label">Inicio:</label>
                                        <input type="time" id="startTime" class="form-input" value="09:00"
                                            style="padding: 0.5rem;">
                                    </div>
                                    <div class="form-group" style="margin-bottom: 0.5rem;">
                                        <label class="form-label">Fin:</label>
                                        <input type="time" id="endTime" class="form-input" value="18:00"
                                            style="padding: 0.5rem;">
                                    </div>
                                    <button type="submit" class="btn-primary"
                                        style="padding: 0.5rem; font-size: 0.9rem; margin-top: 0.5rem;">Guardar</button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Pending Appointments -->
                    <div class="auth-card" style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                        <h2 class="card-title"> Citas Pendientes</h2>
                        <div style="overflow-y: auto; flex: 1;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                                @<thead>
                                    <tr
                                        style="background: var(--secondary-color); text-align: left; position: sticky; top: 0;">
                                        <th style="padding: 0.5rem;">Fecha</th>
                                        <th style="padding: 0.5rem;">Cliente</th>
                                        <th style="padding: 0.5rem;">Acci贸n</th>
                                    </tr>
                                </thead>
                                <tbody id="appointmentsTableBody">
                                    <tr>
                                        <td colspan="3" style="padding:1rem; text-align:center;">Cargando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Calendar -->
                <div class="right-column">
                    <div class="auth-card" style="height: 100%; display: flex; flex-direction: column;">
                        <!-- Calendar Component -->
                        <div class="calendar-container">
                            <div class="calendar-header">
                                <button class="calendar-nav-btn" id="prevMonth">&lt;</button>
                                <h2 class="calendar-title" id="currentMonthLabel">Cargando...</h2>
                                <button class="calendar-nav-btn" id="nextMonth">&gt;</button>
                            </div>

                            <div class="calendar-grid" id="calendarGrid">
                                <!-- JS will inject days here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal for Completing Appointment (Price) -->
            <div id="completeModal"
                style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1100;">
                <div class="auth-card" style="width:90%; max-width:400px; position:relative;">
                    <button id="closeCompleteModal"
                        style="position:absolute; top:1rem; right:1rem; border:none; background:none; font-size:1.2rem; cursor:pointer;">&times;</button>
                    <h2 style="margin-bottom:1rem;">Finalizar Cita</h2>
                    <p style="margin-bottom:1rem;">Ingresa el monto cobrado por este servicio:</p>

                    <div class="form-group">
                        <label class="form-label">Precio ($):</label>
                        <input type="number" id="servicePrice" class="form-input" placeholder="0.00" min="0">
                    </div>

                    <button id="confirmCompleteBtn" class="btn-primary">Guardar y Finalizar</button>
                </div>
            </div>

            <!-- Modal para Gestionar D铆a -->
            <div id="dayModal"
                style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">
                <div class="auth-card" style="width:90%; max-width:400px; position:relative;">
                    <button id="closeModal"
                        style="position:absolute; top:1rem; right:1rem; border:none; background:none; font-size:1.2rem; cursor:pointer;">&times;</button>
                    <h2 id="modalDateTitle" style="margin-bottom:1rem;">Gestionar Fecha</h2>

                    <div class="form-group">
                        <label class="form-label">Estado del D铆a:</label>
                        <select id="dayStatus" class="form-input">
                            <option value="open">Abierto (Normal)</option>
                            <option value="closed">Cerrado (Bloqueado)</option>
                        </select>
                    </div>

                    <div id="customHoursBlock">
                        <p style="font-size:0.9rem; margin-bottom:0.5rem; color:var(--accent-color);">Horario Especial
                            (Opcional):</p>
                        <div class="form-group">
                            <label class="form-label">Inicio:</label>
                            <input type="time" id="dayStart" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fin:</label>
                            <input type="time" id="dayEnd" class="form-input">
                        </div>
                    </div>

                    <button id="saveDayBtn" class="btn-primary">Guardar Cambios</button>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { saveAvailabilitySettings, loadAvailabilitySettings } from '../js/availability.js';
        import { initCalendar } from '../js/calendar-admin.js';
        import { initAppointmentsAdmin } from '../js/appointments-admin.js';
        import { checkLowStockAlert } from '../js/admin-utils.js';

        // Cargar configuraci贸n al iniciar
        window.addEventListener('DOMContentLoaded', async () => {
            initCalendar(); // Init dynamic calendar
            initAppointmentsAdmin(); // Load Appointments Table
            checkLowStockAlert("stock-alert-float");

            const settings = await loadAvailabilitySettings();
            if (settings) {
                // Set Times
                document.getElementById('startTime').value = settings.startTime;
                document.getElementById('endTime').value = settings.endTime;

                // Set Days
                const checkboxes = document.querySelectorAll('input[name="days"]');
                checkboxes.forEach(cb => {
                    cb.checked = settings.workDays.includes(parseInt(cb.value));
                });
            }
        });

        // Guardar configuraci贸n
        document.getElementById('availabilityForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const start = document.getElementById('startTime').value;
            const end = document.getElementById('endTime').value;

            const checkboxes = document.querySelectorAll('input[name="days"]:checked');
            const days = Array.from(checkboxes).map(cb => parseInt(cb.value));

            await saveAvailabilitySettings(days, start, end);
        });
    </script>
</body>

</html>